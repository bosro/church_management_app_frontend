<!-- src/app/features/user-roles/components/role-templates/role-templates.component.html -->
<div class="dashboard-layout">
  <app-sidebar></app-sidebar>

  <div class="dashboard-content">
    <app-header></app-header>

    <div class="dashboard-body">
      <div class="templates-container">
        <!-- Page Header -->
        <div class="page-header">
          <div class="header-left">
            <button class="back-btn" (click)="goBack()">
              <i class="ri-arrow-left-line"></i>
            </button>
            <div>
              <h1>Role Templates</h1>
              <p class="subtitle">Create reusable permission sets</p>
            </div>
          </div>
          <button class="btn-primary" (click)="openCreateModal()">
            <i class="ri-add-line"></i>
            Create Template
          </button>
        </div>

        <!-- Success/Error Messages -->
        <div *ngIf="successMessage" class="success-alert">
          <i class="ri-checkbox-circle-line"></i>
          <span>{{ successMessage }}</span>
        </div>

        <div *ngIf="errorMessage" class="error-alert">
          <i class="ri-error-warning-line"></i>
          <span>{{ errorMessage }}</span>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="loading-container">
          <app-loading-spinner message="Loading templates..."></app-loading-spinner>
        </div>

        <!-- Templates Grid -->
        <div *ngIf="!loading" class="templates-grid">
          <div *ngFor="let template of roleTemplates" class="template-card">
            <div class="card-header">
              <div class="template-icon">
                <i class="ri-shield-user-line"></i>
              </div>
              <div class="card-actions">
                <button class="btn-icon-small" (click)="openEditModal(template)">
                  <i class="ri-edit-line"></i>
                </button>
                <button class="btn-icon-small btn-danger" (click)="deleteTemplate(template.id, $event)">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </div>
            </div>

            <div class="card-body">
              <h3>{{ template.role_name }}</h3>
              <p class="template-description" *ngIf="template.description">
                {{ template.description }}
              </p>

              <div class="permission-count">
                <i class="ri-checkbox-circle-line"></i>
                <span>{{ template.permissions?.length || 0 }} permission{{ (template.permissions?.length || 0) !== 1 ? 's' : '' }}</span>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="roleTemplates.length === 0" class="empty-state">
            <i class="ri-shield-user-line"></i>
            <h3>No Role Templates</h3>
            <p>Create your first role template to quickly assign permissions</p>
            <button class="btn-primary" (click)="openCreateModal()">
              <i class="ri-add-line"></i>
              Create Template
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Template Modal -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Create Role Template</h2>
      <button class="close-btn" (click)="closeCreateModal()">
        <i class="ri-close-line"></i>
      </button>
    </div>

    <div class="modal-body">
      <form [formGroup]="templateForm">
        <div class="form-group">
          <label for="role_name">Template Name *</label>
          <input
            id="role_name"
            type="text"
            formControlName="role_name"
            placeholder="e.g., Ministry Leader, Finance Manager"
          />
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            formControlName="description"
            placeholder="Describe this role..."
            rows="3"
          ></textarea>
        </div>
      </form>

      <div class="permissions-section">
        <h3>Select Permissions</h3>

        <div *ngFor="let category of permissionsByCategory | keyvalue" class="permission-category">
          <div class="category-header">
            <div class="category-info">
              <i [class]="getCategoryIcon(category.key)"></i>
              <h4>{{ getCategoryLabel(category.key) }}</h4>
            </div>
            <button
              class="btn-toggle-category"
              (click)="toggleCategoryPermissions(category.key)"
            >
              <i [class]="isCategoryFullySelected(category.key) ? 'ri-checkbox-line' : 'ri-checkbox-blank-line'"></i>
              {{ isCategoryFullySelected(category.key) ? 'Deselect All' : 'Select All' }}
            </button>
          </div>

          <div class="permissions-list">
            <label
              *ngFor="let permission of category.value"
              class="permission-checkbox"
              [class.selected]="selectedPermissions.has(permission.name)"
            >
              <input
                type="checkbox"
                [checked]="selectedPermissions.has(permission.name)"
                (change)="togglePermission(permission.name)"
              />
              <div class="permission-label">
                <span class="label-text">{{ permission.label }}</span>
                <span class="label-description">{{ permission.description }}</span>
              </div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeCreateModal()">
        Cancel
      </button>
      <button class="btn-primary" (click)="createTemplate()">
        <i class="ri-save-line"></i>
        Create Template
      </button>
    </div>
  </div>
</div>

<!-- Edit Template Modal -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Edit Role Template</h2>
      <button class="close-btn" (click)="closeEditModal()">
        <i class="ri-close-line"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Same form structure as create modal -->
      <form [formGroup]="templateForm">
        <div class="form-group">
          <label for="edit_role_name">Template Name *</label>
          <input
            id="edit_role_name"
            type="text"
            formControlName="role_name"
            placeholder="e.g., Ministry Leader, Finance Manager"
          />
        </div>

        <div class="form-group">
          <label for="edit_description">Description</label>
          <textarea
            id="edit_description"
            formControlName="description"
            placeholder="Describe this role..."
            rows="3"
          ></textarea>
        </div>
      </form>

      <div class="permissions-section">
        <h3>Select Permissions</h3>

        <div *ngFor="let category of permissionsByCategory | keyvalue" class="permission-category">
          <div class="category-header">
            <div class="category-info">
              <i [class]="getCategoryIcon(category.key)"></i>
              <h4>{{ getCategoryLabel(category.key) }}</h4>
            </div>
            <button
              class="btn-toggle-category"
              (click)="toggleCategoryPermissions(category.key)"
            >
              <i [class]="isCategoryFullySelected(category.key) ? 'ri-checkbox-line' : 'ri-checkbox-blank-line'"></i>
              {{ isCategoryFullySelected(category.key) ? 'Deselect All' : 'Select All' }}
            </button>
          </div>

          <div class="permissions-list">
            <label
              *ngFor="let permission of category.value"
              class="permission-checkbox"
              [class.selected]="selectedPermissions.has(permission.name)"
            >
              <input
                type="checkbox"
                [checked]="selectedPermissions.has(permission.name)"
                (change)="togglePermission(permission.name)"
              />
              <div class="permission-label">
                <span class="label-text">{{ permission.label }}</span>
                <span class="label-description">{{ permission.description }}</span>
              </div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeEditModal()">
        Cancel
      </button>
      <button class="btn-primary" (click)="updateTemplate()">
        <i class="ri-save-line"></i>
        Update Template
      </button>
    </div>
  </div>
</div>
