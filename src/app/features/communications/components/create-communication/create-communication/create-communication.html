<!-- src/app/features/communications/components/create-communication/create-communication.component.html -->
<div class="dashboard-layout">
  <app-sidebar></app-sidebar>

  <div class="dashboard-content">
    <app-header></app-header>

    <div class="dashboard-body">
      <div class="create-communication-container">
        <!-- Page Header -->
        <div class="page-header">
          <div class="header-left">
            <button class="back-btn" (click)="cancel()">
              <i class="ri-arrow-left-line"></i>
            </button>
            <div>
              <h1>New Message</h1>
              <p class="subtitle">Send SMS or email to your members</p>
            </div>
          </div>
        </div>

        <!-- Success Message -->
        <div *ngIf="successMessage" class="success-alert">
          <i class="ri-checkbox-circle-line"></i>
          <span>{{ successMessage }}</span>
        </div>

        <!-- Error Message -->
        <div *ngIf="errorMessage" class="error-alert">
          <i class="ri-error-warning-line"></i>
          <span>{{ errorMessage }}</span>
        </div>

        <div class="form-layout">
          <!-- Main Form -->
          <div class="form-card">
            <form [formGroup]="communicationForm" (ngSubmit)="onSubmit()">
              <!-- Message Details -->
              <div class="form-section">
                <h3>Message Details</h3>

                <div class="form-grid">
                  <!-- Title -->
                  <div class="form-group full-width">
                    <label for="title">Message Title *</label>
                    <input
                      id="title"
                      type="text"
                      formControlName="title"
                      placeholder="e.g., Sunday Service Reminder, Event Announcement"
                      [class.error]="communicationForm.get('title')?.invalid && communicationForm.get('title')?.touched"
                    />
                    <span
                      *ngIf="communicationForm.get('title')?.invalid && communicationForm.get('title')?.touched"
                      class="error-message"
                    >
                      {{ getErrorMessage('title') }}
                    </span>
                  </div>

                  <!-- Communication Type -->
                  <div class="form-group">
                    <label for="communication_type">Send Via *</label>
                    <select
                      id="communication_type"
                      formControlName="communication_type"
                      [class.error]="communicationForm.get('communication_type')?.invalid && communicationForm.get('communication_type')?.touched"
                    >
                      <option *ngFor="let type of communicationTypes" [value]="type.value">
                        {{ type.label }}
                      </option>
                    </select>
                  </div>

                  <!-- Target Audience -->
                  <div class="form-group">
                    <label for="target_audience">Send To *</label>
                    <select
                      id="target_audience"
                      formControlName="target_audience"
                      [class.error]="communicationForm.get('target_audience')?.invalid && communicationForm.get('target_audience')?.touched"
                    >
                      <option *ngFor="let audience of targetAudiences" [value]="audience.value">
                        {{ audience.label }}
                      </option>
                    </select>
                  </div>

                  <!-- Message -->
                  <div class="form-group full-width">
                    <label for="message">Message *</label>
                    <textarea
                      id="message"
                      formControlName="message"
                      placeholder="Type your message here..."
                      rows="6"
                      [class.error]="communicationForm.get('message')?.invalid && communicationForm.get('message')?.touched"
                    ></textarea>
                    <div class="character-count">
                      {{ getCharacterCount() }} characters
                      <span *ngIf="communicationForm.get('communication_type')?.value === 'sms'" class="sms-note">
                        (SMS: ~{{ Math.ceil(getCharacterCount() / 160) }} message{{ Math.ceil(getCharacterCount() / 160) > 1 ? 's' : '' }})
                      </span>
                    </div>
                    <span
                      *ngIf="communicationForm.get('message')?.invalid && communicationForm.get('message')?.touched"
                      class="error-message"
                    >
                      {{ getErrorMessage('message') }}
                    </span>
                  </div>

                  <!-- Scheduled At -->
                  <div class="form-group full-width">
                    <label for="scheduled_at">Schedule (Optional)</label>
                    <input
                      id="scheduled_at"
                      type="datetime-local"
                      formControlName="scheduled_at"
                    />
                    <p class="help-text">Leave empty to send immediately</p>
                  </div>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <button
                  type="button"
                  class="btn-secondary"
                  (click)="cancel()"
                  [disabled]="loading"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="btn-primary"
                  [disabled]="loading"
                >
                  <span *ngIf="!loading">
                    <i class="ri-send-plane-line"></i>
                    {{ communicationForm.get('scheduled_at')?.value ? 'Schedule Message' : 'Send Now' }}
                  </span>
                  <span *ngIf="loading">
                    <i class="ri-loader-4-line spin"></i>
                    Sending...
                  </span>
                </button>
              </div>
            </form>
          </div>

          <!-- Templates Sidebar -->
          <div class="templates-sidebar">
            <h3>Message Templates</h3>
            <p class="sidebar-hint">Click to use a template</p>

            <div class="templates-list">
              <div
                *ngFor="let template of messageTemplates"
                class="template-card"
                (click)="applyTemplate(template)"
              >
                <h4>{{ template.name }}</h4>
                <p>{{ template.message }}</p>
                <span class="use-template">
                  <i class="ri-add-circle-line"></i>
                  Use Template
                </span>
              </div>
            </div>

            <div class="template-info">
              <i class="ri-information-line"></i>
              <p>You can use variables like {name}, {date}, {time}, {event_name}, {amount} in your messages.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
