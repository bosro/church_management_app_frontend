<!-- src/app/features/attendance/components/mark-attendance/mark-attendance.component.html -->
<div class="dashboard-layout">
  <app-sidebar></app-sidebar>

  <div class="dashboard-content">
    <app-header></app-header>

    <div class="dashboard-body">
      <div class="mark-attendance-container">
        <!-- Page Header -->
        <div class="page-header">
          <div class="header-left">
            <button class="back-btn" (click)="goBack()">
              <i class="ri-arrow-left-line"></i>
            </button>
            <div>
              <h1>Mark Attendance</h1>
              <p class="subtitle" *ngIf="event">{{ event.event_name }} - {{ event.event_date | date:'MMM d, y' }}</p>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn-secondary" (click)="toggleQRCode()">
              <i class="ri-qr-code-line"></i>
              <span>QR Code</span>
            </button>
            <button
              class="btn-secondary"
              (click)="toggleBulkMode()"
              [class.active]="bulkCheckInMode"
            >
              <i class="ri-checkbox-multiple-line"></i>
              <span>{{ bulkCheckInMode ? 'Cancel Bulk' : 'Bulk Check-in' }}</span>
            </button>
          </div>
        </div>

        <!-- Success Message -->
        <div *ngIf="successMessage" class="success-alert">
          <i class="ri-checkbox-circle-line"></i>
          <span>{{ successMessage }}</span>
        </div>

        <!-- Error Message -->
        <div *ngIf="errorMessage" class="error-alert">
          <i class="ri-error-warning-line"></i>
          <span>{{ errorMessage }}</span>
        </div>

        <!-- QR Code Modal -->
        <div *ngIf="showQRCode" class="qr-modal" (click)="toggleQRCode()">
          <div class="qr-content" (click)="$event.stopPropagation()">
            <button class="close-btn" (click)="toggleQRCode()">
              <i class="ri-close-line"></i>
            </button>
            <h3>Scan to Check In</h3>
            <div class="qr-code-wrapper">
              <!-- In a real app, use a library like ngx-qrcode2 -->
              <div class="qr-placeholder">
                <i class="ri-qr-code-line"></i>
                <p>{{ qrCodeData }}</p>
              </div>
            </div>
            <p class="qr-hint">Members can scan this QR code to check in</p>
          </div>
        </div>

        <div class="content-grid">
          <!-- Check-in Panel -->
          <div class="checkin-panel">
            <div class="panel-card">
              <h3>Check In</h3>

              <!-- Member Search -->
              <div class="search-section">
                <div class="search-input-wrapper">
                  <i class="ri-search-line search-icon"></i>
                  <input
                    type="text"
                    [formControl]="searchControl"
                    placeholder="Search member by name, email, or phone..."
                    class="search-input"
                  />
                  <i *ngIf="searching" class="ri-loader-4-line spin"></i>
                </div>

                <!-- Search Results -->
                <div class="search-results" *ngIf="searchResults.length > 0">
                  <div
                    *ngFor="let member of searchResults"
                    class="search-result-item"
                    (click)="checkInMember(member.id)"
                  >
                    <div class="member-avatar-small">
                      <img *ngIf="member.photo_url" [src]="member.photo_url" [alt]="getMemberFullName(member)" />
                      <div *ngIf="!member.photo_url" class="avatar-placeholder-small">
                        {{ getMemberInitials(member) }}
                      </div>
                    </div>
                    <div class="member-info-small">
                      <p class="member-name-small">{{ getMemberFullName(member) }}</p>
                      <p class="member-meta-small">{{ member.member_number }}</p>
                    </div>
                    <i class="ri-add-circle-line"></i>
                  </div>
                </div>
              </div>

              <!-- Visitor Check-in -->
              <div class="visitor-section">
                <button
                  class="btn-visitor"
                  (click)="toggleVisitorForm()"
                  *ngIf="!showVisitorForm"
                >
                  <i class="ri-user-add-line"></i>
                  <span>Check In Visitor</span>
                </button>

                <div *ngIf="showVisitorForm" class="visitor-form">
                  <h4>Visitor Information</h4>

                  <div class="form-group">
                    <label>Full Name *</label>
                    <input
                      type="text"
                      [(ngModel)]="visitorName"
                      placeholder="Enter visitor name"
                      class="form-input"
                    />
                  </div>

                  <div class="form-group">
                    <label>Phone</label>
                    <input
                      type="tel"
                      [(ngModel)]="visitorPhone"
                      placeholder="Enter phone number"
                      class="form-input"
                    />
                  </div>

                  <div class="form-group">
                    <label>Email</label>
                    <input
                      type="email"
                      [(ngModel)]="visitorEmail"
                      placeholder="Enter email address"
                      class="form-input"
                    />
                  </div>

                  <div class="form-actions-inline">
                    <button
                      class="btn-secondary-small"
                      (click)="toggleVisitorForm()"
                      [disabled]="addingVisitor"
                    >
                      Cancel
                    </button>
                    <button
                      class="btn-primary-small"
                      (click)="checkInVisitor()"
                      [disabled]="addingVisitor"
                    >
                      <span *ngIf="!addingVisitor">Check In</span>
                      <span *ngIf="addingVisitor">
                        <i class="ri-loader-4-line spin"></i>
                        Checking in...
                      </span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Bulk Check-in Button -->
              <div class="bulk-actions" *ngIf="bulkCheckInMode && selectedMembers.size > 0">
                <button class="btn-primary-full" (click)="bulkCheckIn()" [disabled]="loading">
                  <i class="ri-checkbox-multiple-line"></i>
                  <span>Check In {{ selectedMembers.size }} Member{{ selectedMembers.size > 1 ? 's' : '' }}</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Attendance List -->
          <div class="attendance-list-panel">
            <div class="panel-card">
              <div class="panel-header">
                <h3>Checked In ({{ attendanceRecords.length }})</h3>
                <span class="attendance-count" *ngIf="event">
                  {{ event.total_attendance }} / {{ event.expected_attendance || 'âˆž' }}
                </span>
              </div>

              <div class="attendance-list">
                <div
                  *ngFor="let record of attendanceRecords"
                  class="attendance-item"
                  [class.selectable]="bulkCheckInMode"
                >
                  <div class="attendance-info">
                    <div class="member-avatar-small">
                      <img
                        *ngIf="record.member?.photo_url"
                        [src]="record.member?.photo_url"
                        [alt]="getAttendanceName(record)"
                      />
                      <div *ngIf="!record.member?.photo_url" class="avatar-placeholder-small">
                        {{ record.member ? getMemberInitials(record.member) : 'V' }}
                      </div>
                    </div>
                    <div class="attendance-details">
                      <p class="attendance-name">{{ getAttendanceName(record) }}</p>
                      <p class="attendance-time">
                        <i class="ri-time-line"></i>
                        {{ getCheckInTime(record) }}
                      </p>
                    </div>
                  </div>
                  <button
                    class="btn-remove"
                    (click)="removeAttendance(record.id)"
                    title="Remove"
                  >
                    <i class="ri-close-line"></i>
                  </button>
                </div>

                <!-- Empty State -->
                <div *ngIf="attendanceRecords.length === 0" class="empty-state-small">
                  <i class="ri-user-line"></i>
                  <p>No one checked in yet</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


